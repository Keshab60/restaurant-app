<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>
    <link href='https://fonts.googleapis.com/css?family=Baloo Bhai' rel='stylesheet'>
    <link rel="stylesheet" href="/css/payment.css">
    <script
        src="https://www.paypal.com/sdk/js?client-id=ASTQZ6r8OEbA20uZcLzxs9yfSXNdo2NtYdAkbEY6lo-mZSIvysXo1HmqF01zWNjCpxxnwtgWAN8xOhGy"></script>
   
</head>

<body>
    <div id="parent-div">
        <div id="div-of-info">
            <h2>Delivery Information</h2>
            <section class="sections">
                <input type="text" id="firstName" name="firstName" placeholder="First name" required>
                <input type="text" id="lastName" name="lastName" placeholder="Last name" required>
            </section>
            <input type="email" id="email" name="email" placeholder="example@example.com" required>
            <input type="text" id="street" name="street" placeholder="123 Main St" required>
            <section class="sections">
                <input type="text" id="city" name="city" placeholder="City" required>
                <input type="text" id="state" name="state" placeholder="State" required>
            </section>
            <section class="sections">
                <input type="text" id="pin" name="pin" placeholder="Postal code" required>
                <input type="text" id="country" name="country" placeholder="Country" required>
            </section>
            <input type="tel" id="phone" name="phone" placeholder="Phone e.g. +1234567890" required>
        </div>
        <div>
            <div class="cart-total">
                <h3>Cart Totals</h3>
                <div class="sub-cart-total subtotal">
                    <p>Subtotal</p>
                    <% cart2info.forEach(item=> { %>
                        <p>
                            <%= item.Subtotal %>
                        </p>
                        <% }) %>
                </div>
                <div class="sub-cart-total delivery">
                    <p>Delivery Fee</p>
                    <% cart2info.forEach(item=> { %>
                        <p>
                            <%= item.DeliveryCharge %>
                        </p>
                        <% }) %>
                </div>
                <div class="sub-cart-total Total">
                    <h3>Total</h3>
                    <% cart2info.forEach(item=> { %>
                        <p>
                            <%= item.Total%>
                        </p>
                        <% }) %>
                </div>
            </div>
            <div id="paypal-button-container"></div>
        </div>
    </div>
    <div id="keshab">click here</div>
    <script>
        document.querySelector("#keshab").addEventListener("click", async () => {
            const firstname = document.getElementById("firstName").value;
            const lastname = document.getElementById("lastName").value;
            const phone = document.getElementById("phone").value;
            const email = document.getElementById("email").value;
            const state = document.getElementById("state").value;
            const city = document.getElementById("city").value;
            const street = document.getElementById("street").value;
            const pin = document.getElementById("pin").value;

            async function getdishinfo() {
                const Dish = [];
                const Quantity = [];
                const price = []
                await fetch('/api/dishinfo')
                    .then(res => res.json())
                    .then(data => {
                        console.log(data);
                        for (i = 0; i < data.dishinfo.length; i++) {
                            Dish[i] = data.dishinfo[i].Dishname
                            Quantity[i] = data.dishinfo[i].ItemQuantity
                            price[i] = data.dishinfo[i].TotalPrice
                        }
                        console.log(Dish)
                    })
                return { Dish, Quantity, price };
            }
            const { Dish, Quantity, price } = await getdishinfo();
            let totalamount = 0;
            for (let i = 0; i < price.length; i++) {
                totalamount += price[i]
            }

            const orderData = {
                Firstname: firstname,
                Lastname: lastname,
                CustomerPhone: phone,
                EmailId: email,
                Street: street,
                State: state,
                City: city,
                Pin: pin,
                Dish: Dish,
                OrderQuantity: Quantity,
                price: price,
                totalPrice: totalamount,
            };
            const response = await fetch("https://restaurant-app-61ro.onrender.com/api/orders", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify(orderData)
            });

            const result = await response.json();
            alert(result.message || "Order placed successfully!");
        })

        paypal.Buttons({
            createOrder: function (data, actions) {
                return fetch("https://restaurant-app-61ro.onrender.com/create-order", {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/json"
                    },
                    body: JSON.stringify({})
                })
                    .then(res => res.json())
                    .then(data => data.orderID);
            },
            onApprove: function (data, actions) {
                return actions.order.capture().then(function (details) {
                    alert('Transaction completed by ' + details.payer.name.given_name);
                });
            }
        }).render('#paypal-button-container');
    </script>
</body>

</html>
